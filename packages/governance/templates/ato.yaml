# governance/ato.yaml
# Advisory (warn) rules used by platform.scan_workloads / platform.scan_networks.

ato:
  profiles:
    default:
      webapp:
        rules:
          APP_TLS_MIN_BELOW_1_2:
            controls: [SC-13, SC-8]
            suggest: "Set minimum TLS version to 1.2 and disable legacy protocols."
          APP_HTTPS_ONLY_DISABLED:
            controls: [SC-23]
            suggest: "Enable HTTPS-only on the Web App."
          APP_FTPS_NOT_DISABLED:            
            controls: [CM-7]
            suggest: "Disable FTPS (set ftpsState: Disabled)."
          APP_MSI_DISABLED:
            controls: [AC-3, IA-2]
            suggest: "Enable system-assigned identity on the Web App."
          APP_DIAG_NO_LAW:
            controls: [AU-6, AU-12]
            suggest: "Enable diagnostic settings to a Log Analytics Workspace."
      appPlan:
        rules:
          PLAN_MIN_TLS_BELOW_1_2:
            controls: [SC-13, SC-8]
            suggest: "Set minimum TLS version to 1.2 and disable legacy protocols."
      functionApp:
        rules:
          FUNC_TLS_MIN_BELOW_1_2:
            controls: [SC-13, SC-8]
            suggest: "Set minimum TLS version to 1.2 and disable legacy protocols."
          FUNC_HTTPS_ONLY_DISABLED:
            controls: [SC-23]
            suggest: "Enable HTTPS-only on the Function App."
          FUNC_FTPS_NOT_DISABLED:
            controls: [CM-7]
            suggest: "Disable FTPS (set ftpsState: Disabled)."
          FUNC_MSI_DISABLED:
            controls: [AC-3, IA-2]
            suggest: "Enable system-assigned identity on the Function App."
          FUNC_DIAG_NO_LAW:
            controls: [AU-6, AU-12]
            suggest: "Enable diagnostic settings to a Log Analytics Workspace."
      storageAccount:
        rules:
          STOR_TLS_MIN_BELOW_1_2:
            controls: [SC-13, SC-8]
            suggest: "Set minimum TLS version to 1.2 and disable legacy protocols."
          STOR_HNS_DISABLED:
            controls: [AC-3, AC-6]
            suggest: "Enable Hierarchical Namespace (HNS) on the Storage Account."
          STOR_MSI_DISABLED:
            controls: [AC-3, IA-2]
            suggest: "Enable system-assigned identity on the Storage Account."
          STOR_DIAG_NO_LAW:
            controls: [AU-6, AU-12]
            suggest: "Enable diagnostic settings to a Log Analytics Workspace."
      sqlDatabase:
        rules:
          SQL_MSI_DISABLED:
            controls: [AC-3, IA-2]
            suggest: "Enable system-assigned identity on the SQL Server."
          SQL_DIAG_NO_LAW:
            controls: [AU-6, AU-12]
            suggest: "Enable diagnostic settings to a Log Analytics Workspace."
          SQL_AUDIT_NOT_ENABLED:
            controls: [AU-6, AU-12]
            suggest: "Enable Auditing on the SQL Server to a Log Analytics Workspace."    
      network:
        policies:
          - id: "SC-5.vnet-ddos-plan"
            description: "Attach a DDoS plan to VNets hosting internet-facing workloads"
            target: { tool: "ato.network.vnet" }
            effect: warn
            checks:
              - { type: "requiredPresent", path: "ddosProtectionPlan.id", message: "Consider DDoS Protection Plan" }
            suggest:
              - title: "DDoS Protection Plan"
                text: "Enable Standard DDoS plan on critical VNets (SC-5)."

          - id: "SC-7.subnet-nsg-required"
            description: "Subnets should have an NSG"
            target: { tool: "ato.network.subnet" }
            effect: warn
            checks:
              - { type: "requiredPresent", path: "networkSecurityGroup.id", message: "Attach NSG to subnet" }
            suggest:
              - title: "NSG on Subnets"
                text: "Ensure each subnet has an NSG with least-privilege rules (SC-7)."

          - id: "SC-7.subnet-private-endpoints"
            description: "PE subnets should disable network policies"
            target: { tool: "ato.network.subnet" }
            effect: warn
            checks:
              - { type: "equals", path: "privateEndpointNetworkPolicies", value: "Disabled", message: "Disable policies for PE subnets" }
            suggest:
              - title: "Private Endpoints"
                text: "For Private Endpoint subnets, set privateEndpointNetworkPolicies=Disabled (SC-7)."

          - id: "SC-7.nsg-general-advisory"
            description: "Review inbound NSG rules (22/3389/public)"
            target: { tool: "ato.network.nsg" }
            effect: warn
            checks:
              # Always attach suggestion; harmless gentle advisory
              - { type: "requiredPresent", path: "id" }
            suggest:
              - title: "Audit NSG Ingress"
                text: "Check for 0.0.0.0/0 to 22/3389 and restrict by source ranges; prefer JIT or Private Access (SC-7)."

          - id: "SC-7.public-ip-standard"
            description: "Use Standard SKU Public IPs"
            target: { tool: "ato.network.public_ip" }
            effect: warn
            checks:
              - { type: "notEquals", path: "sku.name", value: "Basic", message: "Avoid Basic SKU public IPs" }
            suggest:
              - title: "Public IP SKU"
                text: "Use Standard SKU public IPs for zone-redundancy and better security defaults (SC-7)."
      key_vault:
        policies:
          - id: "SC-7.kv-private-endpoints"
            description: "KV should prefer private endpoints + RBAC"
            target: { tool: "ato.workload.key_vault" }
            effect: warn
            checks:
              - { type: "equals", path: "properties.enableRbacAuthorization", value: true, message: "Prefer RBAC authorization" }
              - { type: "notEquals", path: "properties.publicNetworkAccess", value: "Enabled", message: "Consider Private Endpoint + firewall" }
            suggest:
              - title: "KV Access Model"
                text: "Enable RBAC and move to Private Endpoints with firewall allow-listing (SC-7)."