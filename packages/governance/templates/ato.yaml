# governance/ato.yaml
# Advisory (warn) rules used by platform.scan_workloads / platform.scan_networks.

ato:
  workload:
    policies:
      - id: "SC-8.SC-13.webapp-https-only"
        description: "HTTPS-only must be enabled on App Service"
        target: { tool: "ato.workload.web_app" }
        effect: warn
        checks:
          - { type: "requiredTrue", path: "properties.httpsOnly", message: "Enable HTTPS-only" }
        suggest:
          - title: "Enforce HTTPS-only"
            text: "Set httpsOnly=true and minimum TLS â‰¥ 1.2 (NIST 800-53 SC-8/SC-13)."

      - id: "SC-13.webapp-min-tls"
        description: "Minimum TLS version should be 1.2+"
        target: { tool: "ato.workload.web_app" }
        effect: warn
        checks:
          - { type: "equals", path: "properties.siteConfig.minimumTlsVersion", value: "1.2", message: "Set min TLS to 1.2+" }
        suggest:
          - title: "TLS 1.2+"
            text: "Configure minimumTlsVersion=1.2 in siteConfig (SC-13)."

      - id: "AU-2.AU-6.webapp-diagnostics-law"
        description: "Send diagnostics to Log Analytics"
        target: { tool: "ato.workload.web_app" }
        effect: warn
        checks:
          - { type: "requiredPresent", path: "diagnosticWorkspaceResourceId", message: "Diagnostic settings to LAW missing" }
        suggest:
          - title: "Centralized Logging"
            text: "Enable Diagnostic Settings to LAW; include HTTP logs, metrics, and audit (AU-2/AU-6)."

      - id: "IA-2.webapp-identity"
        description: "Prefer system-assigned identity"
        target: { tool: "ato.workload.web_app" }
        effect: warn
        checks:
          - { type: "requiredTrue", path: "identity.systemAssigned", message: "Enable system-assigned identity" }
        suggest:
          - title: "Managed Identity"
            text: "Enable system-assigned managed identity and use it for Key Vault/Storage access (IA-2)."

  network:
    policies:
      - id: "SC-5.vnet-ddos-plan"
        description: "Attach a DDoS plan to VNets hosting internet-facing workloads"
        target: { tool: "ato.network.vnet" }
        effect: warn
        checks:
          - { type: "requiredPresent", path: "ddosProtectionPlan.id", message: "Consider DDoS Protection Plan" }
        suggest:
          - title: "DDoS Protection Plan"
            text: "Enable Standard DDoS plan on critical VNets (SC-5)."

      - id: "SC-7.subnet-nsg-required"
        description: "Subnets should have an NSG"
        target: { tool: "ato.network.subnet" }
        effect: warn
        checks:
          - { type: "requiredPresent", path: "networkSecurityGroup.id", message: "Attach NSG to subnet" }
        suggest:
          - title: "NSG on Subnets"
            text: "Ensure each subnet has an NSG with least-privilege rules (SC-7)."

      - id: "SC-7.subnet-private-endpoints"
        description: "PE subnets should disable network policies"
        target: { tool: "ato.network.subnet" }
        effect: warn
        checks:
          - { type: "equals", path: "privateEndpointNetworkPolicies", value: "Disabled", message: "Disable policies for PE subnets" }
        suggest:
          - title: "Private Endpoints"
            text: "For Private Endpoint subnets, set privateEndpointNetworkPolicies=Disabled (SC-7)."

      - id: "SC-7.nsg-general-advisory"
        description: "Review inbound NSG rules (22/3389/public)"
        target: { tool: "ato.network.nsg" }
        effect: warn
        checks:
          # Always attach suggestion; harmless gentle advisory
          - { type: "requiredPresent", path: "id" }
        suggest:
          - title: "Audit NSG Ingress"
            text: "Check for 0.0.0.0/0 to 22/3389 and restrict by source ranges; prefer JIT or Private Access (SC-7)."

      - id: "SC-7.public-ip-standard"
        description: "Use Standard SKU Public IPs"
        target: { tool: "ato.network.public_ip" }
        effect: warn
        checks:
          - { type: "notEquals", path: "sku.name", value: "Basic", message: "Avoid Basic SKU public IPs" }
        suggest:
          - title: "Public IP SKU"
            text: "Use Standard SKU public IPs for zone-redundancy and better security defaults (SC-7)."

  key_vault:
    policies:
      - id: "SC-7.kv-private-endpoints"
        description: "KV should prefer private endpoints + RBAC"
        target: { tool: "ato.workload.key_vault" }
        effect: warn
        checks:
          - { type: "equals", path: "properties.enableRbacAuthorization", value: true, message: "Prefer RBAC authorization" }
          - { type: "notEquals", path: "properties.publicNetworkAccess", value: "Enabled", message: "Consider Private Endpoint + firewall" }
        suggest:
          - title: "KV Access Model"
            text: "Enable RBAC and move to Private Endpoints with firewall allow-listing (SC-7)."